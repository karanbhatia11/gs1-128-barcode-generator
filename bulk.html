<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GS1-128 Bulk Generator</title>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
@page {
  size: A4 landscape;
  margin: 0;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #ffffff;
  color: #111;
}

.controls {
  padding: 20px;
}
.controls button {
  padding: 8px 16px;
  margin-right: 10px;
}

@media print {
  .controls { display: none; }
}

.page {
  width: 100vw;
  height: 100vh;
  page-break-after: always;
  display: flex;
  justify-content: center;
  align-items: center;
}

.canvas {
  width: 88%;
}

.header {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  margin-bottom: 10mm;
}

.header .spacer {
  height: 1px;
}

.header img {
  height: 32px;
}

.meta {
  margin-bottom: 12mm;
}

.meta div {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 3mm;
}

.barcode-section {
  margin-bottom: 16mm;
}

.barcode-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4mm;
}

svg {
  width: 100%;
}
</style>
</head>

<body>

<div class="controls">
  <h2>GS1-128 Bulk Generator</h2>
  <input type="file" id="excelFile" accept=".xlsx">
  <button onclick="generateFromExcel()">Generate from Excel</button>
  <button onclick="window.print()">Download PDF</button>
</div>

<div id="pages"></div>

<script>
function safeGet(row, keys) {
  for (const k of keys) {
    if (row[k] !== undefined && row[k] !== null && row[k] !== "") {
      return row[k];
    }
  }
  return "";
}

function normaliseExpiry(value) {
  if (!value) return null;

  if (value instanceof Date) {
    const dd = String(value.getDate()).padStart(2, "0");
    const mm = String(value.getMonth() + 1).padStart(2, "0");
    const yy = String(value.getFullYear()).slice(-2);
    return dd + "." + mm + "." + yy;
  }

  return String(value).trim();
}

function generatePage(data) {
  const expiryStr = normaliseExpiry(data.expiry);
  if (!expiryStr || !expiryStr.includes(".")) {
    console.warn("Skipping row due to invalid expiry:", data);
    return null;
  }

  const parts = expiryStr.split(".");
  if (parts.length !== 3) {
    console.warn("Skipping row due to malformed expiry:", data);
    return null;
  }

  const [dd, mm, yy] = parts;
  const expiry = yy + mm + dd;

  const GS = String.fromCharCode(29);

  const page = document.createElement("div");
  page.className = "page";

  page.innerHTML = `
    <div class="canvas">
      <div class="header">
        <div class="spacer"></div>
        <img src="logo.svg" alt="Skutopia Logo">
        <div class="spacer"></div>
      </div>

      <div class="meta">
        <div class="itemText"></div>
        <div class="ssccText"></div>
      </div>

      <div class="barcode-section">
        <div class="barcode-title">BARCODE 1</div>
        <svg class="itemBarcode"></svg>
      </div>

      <div class="barcode-section">
        <div class="barcode-title">BARCODE 2</div>
        <svg class="ssccBarcode"></svg>
      </div>
    </div>
  `;

  const itemText = page.querySelector(".itemText");
  const ssccText = page.querySelector(".ssccText");
  const itemBarcode = page.querySelector(".itemBarcode");
  const ssccBarcode = page.querySelector(".ssccBarcode");

  const itemGS1Encoded =
    "02" + data.gtin +
    GS + "17" + expiry +
    GS + "10" + data.batch +
    GS + "37" + data.quantity;

  const itemGS1Text =
    "(02)" + data.gtin +
    "(17)" + expiry +
    "(10)" + data.batch +
    "(37)" + data.quantity;

  const ssccGS1Encoded = "00" + data.sscc;
  const ssccGS1Text = "(00)" + data.sscc;

  itemText.innerText = "ITEM NUMBER: " + data.gtin;
  ssccText.innerText = "SSCC: " + data.sscc;

  JsBarcode(itemBarcode, itemGS1Encoded, {
    format: "CODE128",
    displayValue: true,
    text: itemGS1Text,
    width: 2.4,
    height: 125,
    fontSize: 26,
    textMargin: 8,
    margin: 0
  });

  JsBarcode(ssccBarcode, ssccGS1Encoded, {
    format: "CODE128",
    displayValue: true,
    text: ssccGS1Text,
    width: 2.8,
    height: 125,
    fontSize: 26,
    textMargin: 8,
    margin: 0
  });

  return page;
}

function generateFromExcel() {
  const fileInput = document.getElementById("excelFile");
  if (!fileInput.files.length) {
    alert("Please upload an Excel file");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const workbook = XLSX.read(e.target.result, { type: "binary", cellDates: true });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawRows = XLSX.utils.sheet_to_json(sheet);

    if (!rawRows.length) {
      alert("Excel file is empty");
      return;
    }

    const rows = rawRows.map(r => ({
      gtin: safeGet(r, ["gtin", "GTIN"]),
      expiry: safeGet(r, ["expiry", "Expiry", "expiry_dd_mm_yy"]),
      batch: safeGet(r, ["batch", "Batch"]),
      quantity: safeGet(r, ["quantity", "Quantity"]),
      sscc: safeGet(r, ["sscc", "SSCC"])
    }));

    const container = document.getElementById("pages");
    container.innerHTML = "";

    let rendered = 0;
    rows.forEach(row => {
      const page = generatePage(row);
      if (page) {
        container.appendChild(page);
        rendered++;
      }
    });

    if (rendered === 0) {
      alert("No valid rows found. Check Excel format.");
    }
  };

  reader.readAsBinaryString(fileInput.files[0]);
}
</script>



</body>
</html>
